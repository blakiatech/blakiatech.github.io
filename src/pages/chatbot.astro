---
import { Bot, Send, X } from "lucide-react";
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ChatBot - BlakIA</title>
    <script is:inline src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"
    ></script>
    <link href="/src/styles/global.css" rel="stylesheet" />
  </head>
  <body class="h-full m-0 p-0 overflow-hidden font-sans bg-transparent">
    <div
      class="flex flex-col bg-background border border-border h-screen w-full overflow-hidden relative rounded-xl chat-wrapper shadow-2xl"
    >
      <!-- Header -->
      <div
        class="bg-muted/50 p-4 text-center font-semibold text-sm border-b border-border flex justify-between items-center"
      >
        <div class="flex items-center gap-2 text-foreground">
          <div class="bg-primary/10 p-1.5 rounded-full text-primary">
            <Bot size={18} />
          </div>
          <span>Asistente BlakIA</span>
        </div>
        <div
          id="chat-close"
          title="Cerrar chat"
          class="cursor-pointer text-muted-foreground hover:text-foreground transition-colors p-1 hover:bg-muted rounded-md"
        >
          <X size={18} />
        </div>
      </div>

      <!-- Chat Messages -->
      <div
        id="chatbox"
        class="flex-1 p-4 overflow-y-auto flex flex-col gap-4 scroll-smooth"
      >
      </div>

      <!-- Input Area -->
      <div
        id="input-container"
        class="flex flex-col border-t border-border bg-background p-3 gap-2 sticky bottom-0 z-10"
      >
        <div class="flex gap-2 items-end">
          <textarea
            id="user-input"
            placeholder="Escribe tu mensaje..."
            rows="1"
            class="flex-1 min-h-[44px] max-h-[120px] p-3 py-2.5 border border-input rounded-xl bg-background text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary resize-none scrollbar-hide"
          ></textarea>
          <button
            id="send-button"
            class="bg-primary text-primary-foreground h-[44px] w-[44px] flex items-center justify-center rounded-xl cursor-pointer hover:bg-primary/90 transition-all shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <Send size={18} />
          </button>
        </div>
        <div class="text-center">
          <span class="text-[10px] text-muted-foreground"
            >Powered by BlakIA Tech</span
          >
        </div>
      </div>
    </div>

    <script is:inline>
      const chatbox = document.getElementById("chatbox");
      const input = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const closeButton = document.getElementById("chat-close");

      // Auto-resize textarea
      input.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });

      // Load messages from sessionStorage
      const savedMessages = sessionStorage.getItem("chatMessages");
      if (savedMessages) {
        const messages = JSON.parse(savedMessages);
        messages.forEach((msg) =>
          addMessage(msg.text, msg.type, msg.isError, false),
        );
      } else {
        // Initial welcome message if no history
        addMessage(
          "Hola, soy el asistente virtual de BlakIA. ¿En qué puedo ayudarte hoy?",
          "bot",
        );
      }

      function saveMessage(text, type, isError = false) {
        const messages = JSON.parse(
          sessionStorage.getItem("chatMessages") || "[]",
        );
        messages.push({ text, type, isError });
        sessionStorage.setItem("chatMessages", JSON.stringify(messages));
      }

      function addMessage(text, type, isError = false, save = true) {
        if (save) saveMessage(text, type, isError);

        const wrapper = document.createElement("div");
        wrapper.className = `flex flex-col gap-1 max-w-[85%] ${type === "user" ? "items-end self-end" : "items-start self-start"}`;

        // Name label (optional, maybe only for bot)
        if (type === "bot") {
          const label = document.createElement("span");
          label.className = "text-xs text-muted-foreground ml-1";
          label.textContent = "BlakIA";
          wrapper.appendChild(label);
        }

        const msg = document.createElement("div");

        // Tailwind classes for messages
        const baseClasses =
          "p-3 px-4 rounded-2xl break-words whitespace-pre-wrap text-sm leading-relaxed shadow-sm";
        const userClasses =
          "bg-primary text-primary-foreground rounded-tr-none";
        const botClasses =
          "bg-muted text-foreground rounded-tl-none border border-border/50";

        msg.className = `${baseClasses} ${type === "user" ? userClasses : botClasses}`;

        // Use marked if available, otherwise fallback to text
        if (typeof marked !== "undefined" && !isError) {
          msg.innerHTML = marked.parse(text);
          // Add styles to markdown content within the message
          const links = msg.querySelectorAll("a");
          links.forEach(
            (a) => (a.className = "underline font-medium hover:opacity-80"),
          );
          const codes = msg.querySelectorAll("code");
          codes.forEach(
            (c) =>
              (c.className =
                "bg-black/20 px-1 py-0.5 rounded font-mono text-xs"),
          );
        } else {
          msg.textContent = text;
          if (isError)
            msg.innerHTML = `<span class="flex items-center gap-1.5 text-destructive">❌ ${text}</span>`;
        }

        wrapper.appendChild(msg);
        chatbox.appendChild(wrapper);
        chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: "smooth" });
      }

      async function sendMessage(text) {
        addMessage(text, "user");

        // Create typing indicator
        const typingWrapper = document.createElement("div");
        typingWrapper.className =
          "flex flex-col gap-1 items-start max-w-[85%] typing-indicator";

        const label = document.createElement("span");
        label.className = "text-xs text-muted-foreground ml-1";
        label.textContent = "BlakIA";
        typingWrapper.appendChild(label);

        const typingBubble = document.createElement("div");
        typingBubble.className =
          "bg-muted text-foreground rounded-2xl rounded-tl-none p-4 px-4 border border-border/50 flex gap-1 items-center h-[44px]";
        typingBubble.innerHTML = `
            <span class="w-1.5 h-1.5 bg-foreground/40 rounded-full animate-bounce"></span>
            <span class="w-1.5 h-1.5 bg-foreground/40 rounded-full animate-bounce delay-150"></span>
            <span class="w-1.5 h-1.5 bg-foreground/40 rounded-full animate-bounce delay-300"></span>
        `;

        typingWrapper.appendChild(typingBubble);
        chatbox.appendChild(typingWrapper);
        chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: "smooth" });

        try {
          const response = await fetch(
            "https://n8n-main-instance-production-96ac.up.railway.app/webhook/chat",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message: text }),
            },
          );

          const data = await response.json();
          typingWrapper.remove();
          addMessage(
            data.reply || "Lo siento, no tengo respuesta para eso.",
            "bot",
          );
        } catch (error) {
          typingWrapper.remove();
          addMessage("Error de conexión. Intenta más tarde.", "bot", true);
          console.error(error);
        }
      }

      function handleSend() {
        const text = input.value.trim();
        if (text) {
          input.value = "";
          input.style.height = "auto"; // Reset height
          sendMessage(text);
          // Keep focus on mobile to avoid keyboard jumping
          input.focus();
        }
      }

      input.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      });

      sendButton.addEventListener("click", handleSend);

      closeButton.addEventListener("click", () => {
        if (window.parent) {
          window.parent.postMessage({ closeChat: true }, "*");
        }
      });

      // Mobile viewport adjustments
      if (window.visualViewport) {
        const wrapper = document.querySelector(".chat-wrapper");
        function adjustHeight() {
          wrapper.style.height = `${window.visualViewport.height}px`;
          window.scrollTo(0, 0);
        }
        window.visualViewport.addEventListener("resize", adjustHeight);
        window.visualViewport.addEventListener("scroll", adjustHeight);
      }
    </script>
    <style>
      /* Hide scrollbar for Chrome, Safari and Opera */
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      /* Hide scrollbar for IE, Edge and Firefox */
      .scrollbar-hide {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
      .delay-150 {
        animation-delay: 150ms;
      }
      .delay-300 {
        animation-delay: 300ms;
      }
    </style>
  </body>
</html>
